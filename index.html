<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>SAVE THE WORLD</title>
    <meta name="description" content="HELLO THIS IS WEBPAGE">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/92/three.js"></script>
    <script
			  src="https://code.jquery.com/jquery-3.3.1.js"
			  integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
			  crossorigin="anonymous"></script>
    <script src='Stats.js'></script>
    <script src='main.js'></script>
    <script src='sprites.js'></script>
    <script src='audio.js'></script>

    <style>
      #menu {
        border: 1px solid black;
        padding: 5px;
        margin: 5px;
      }
    </style>
  </head>
  <body>

    <div id='main'></div>

    <div id='menu'>

      <h2>Title</h2>

      <h4>For LDJAM 41: Combine 2 Incompatable Genres</h4>


      Song: <select id='songSelect'></select>
      <button onClick='submitMenu()'>Start</button>
    </div>

    <script>

      function menu(){
        $('#menu').css({display: 'block'})
        let select = $('#songSelect')
        for(let ii = 0; ii < Music.length; ii++){
          let file = Music[ii];
          let name = SongNames[ii];
          $('<option value="' + file + '">' + name + '</option>').appendTo(select);
        }
      }
      $(menu)

      function submitMenu(){
        startLoadingLevel($('#songSelect').val())
      }

      function startLevel(audioData){
        let stats = new Stats()
        document.body.appendChild(stats.dom);
        $(stats.dom).css({
          left: '',
          right: 0,
        })

        // Launch an instance of the game with the tag above as its connection to the page
        let game = new Game($('#main'), audioData)
        var lastTimestamp = 0
        var running = true;

        function render(timestamp){
          stats.begin()
          try{
            window.requestAnimationFrame(render)
            let delta = (timestamp - lastTimestamp)/1000
            lastTimestamp = timestamp
            game.update(delta)
            game.draw(delta)
          } catch (error){
            console.error(error)
          }
          stats.end()
        }
        render(0)
      }


      function startLoadingLevel(path){

        $('#menu').css({display: 'none'})

        console.warn("Show loading screen")

        let spritesReady = false
        let audioReady = false
        let audioData = null

        function maybeStart(){
          if(spritesReady && audioReady){
            console.warn("hide loading screen")
            startLevel(audioData)
          }
        }

        GetMusic(path, (data) => {
          audioData = data
          audioReady = true;
          maybeStart();
        })

        // Ask three to load the graphics
        LoadAllSprites(() => {
          spritesReady = true;
          maybeStart()
        })
      }

    </script>
  </body>
</html>
