<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>SAVE THE WORLD</title>
    <meta name="description" content="HELLO THIS IS WEBPAGE">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/92/three.js"></script>
    <!-- <script src="https://cdnjs.com/libraries/rangeslider.js"></script> -->
    <script
			  src="https://code.jquery.com/jquery-3.3.1.js"
			  integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
			  crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>

    <script src='Stats.js'></script>
    <script src='main.js'></script>
    <script src='sprites.js'></script>
    <script src='audio.js'></script>

    <style>
      #main {
        display: none;
      }

      .menu {
        border: 1px solid black;
        padding: 5px;
        margin: 5px;
      }

      #victory {
        display: none;
      }

      #defeat {
        display: none;
      }

      .shadowbox {
        position: absolute;
        top: 0px;
        left: 0px;
        width: 100%;
        height: 100%;
        opacity: 0.5;
        z-index: 1000;
        background-color: #444444;
      }

      .overlay {
        position: absolute;
        top: 20%;
        left: 20%;
        right: 20%;
        bottom: 20%;
        z-index: 1100;
        background-color: #cccccc;
        box-shadow: 5px 4px 6px 0px rgba(0,0,0,0.75);
        -webkit-box-shadow: 5px 4px 6px 0px rgba(0,0,0,0.75);
        -moz-box-shadow: 5px 4px 6px 0px rgba(0,0,0,0.75);
      }

      .credit {
        float: left;
      }

      .licence {
        float: right;
      }

      .credit-row{
        clear: both;
        /* display: flex;
        flex-direction: row; */
      }

    </style>
  </head>
  <body>

    <div id='main'></div>

    <div id='menu'>
      <div class='menu'>

        <h2>Rhythm Defence</h2>
        <h4>For LDJAM 41: Combine 2 Incompatable Genres</h4>

        Song: <select id='songSelect'></select>
        <button onClick='submitMenu()'>Start</button>

        <div>
          <input id='menu-volume' type="range" min='0' max='1000' value='500' onchange='VolumeSliderChange(arguments[0])'>
        </div>

        <div>
          <select id='difficulty' onchange='SetDifficulty(arguments[0])'>
            <option value='0.5'>Relaxed</option>
            <option value='0.8'>Easy</option>
            <option selected value='1'>Normal</option>
            <option value='1.5'>Hard</option>
            <option value='2'>Very Hard</option>
            <option value='3'>Nonsense</option>
          </select>
          <script>
            if(typeof Cookies.get('difficulty') == 'undefined') SetDifficulty({target: document.getElementById('difficulty')})
            $('#difficulty').val(Cookies.get('difficulty'));

            function SetDifficulty(event){
              let target = $(event.target);
              Cookies.set('difficulty', target.val())
              Cookies.set('difficulty-name', target[0].selectedOptions[0].text)
            }

          </script>
        </div>

      </div>
      <div class='menu'>
        <h3>Scoreboard (Local only)</h3>
        <table id='scoreboard'>
          <tr><th>Track</th><th>In Victory</th><th>In Defeat</th></tr>
        </table>
      </div>

      <div class='menu'>
        <b> Disclaimer: </b> This leader board operates on the honour system.
        <div>Enter a name to use for the jam's scoreboard <input id='username' type='text'><button onclick='SetName()'>Save</button></div>
        <h3>Scoreboard (Jam)</h3>
        <div id='scoreTables'></div>
      </div>

      <div class='menu'>
        <div class='credit-row'>
          <div class='credit'>"Motherlode" Kevin MacLeod (incompetech.com)</div>
          <div class='licence'>Licensed under <a href='http://creativecommons.org/licenses/by/3.0/'>Creative Commons: By Attribution 3.0 License</a></div>
        </div>

        <div class='credit-row'>
          <div class='credit'>"Iron Bacon" Kevin MacLeod (incompetech.com)</div>
          <div class='licence'>Licensed under <a href='http://creativecommons.org/licenses/by/3.0/'>Creative Commons: By Attribution 3.0 License</a></div>
        </div>

        <div class='credit-row'>
          <div class='credit'>"Pump" Kevin MacLeod (incompetech.com)</div>
          <div class='licence'>Licensed under <a href='http://creativecommons.org/licenses/by/3.0/'>Creative Commons: By Attribution 3.0 License</a></div>
        </div>

        <div class='credit-row'>
          <div class='credit'>"Meatball Parade" Kevin MacLeod (incompetech.com)</div>
          <div class='licence'>Licensed under <a href='http://creativecommons.org/licenses/by/3.0/'>Creative Commons: By Attribution 3.0 License</a></div>
        </div>

        <div class='credit-row'>
          <div class='credit'>"Mega Hyper Ultrastorm" Kevin MacLeod (incompetech.com)</div>
          <div class='licence'>Licensed under <a href='http://creativecommons.org/licenses/by/3.0/'>Creative Commons: By Attribution 3.0 License</a></div>
        </div>

        <div class='credit-row'>
          <div class='credit'>"Exciting Trailer" Kevin MacLeod (incompetech.com)</div>
          <div class='licence'>Licensed under <a href='http://creativecommons.org/licenses/by/3.0/'>Creative Commons: By Attribution 3.0 License</a></div>
        </div>

        <div class='credit-row'>
          <div class='credit'>"Gregorian Chant" Kevin MacLeod (incompetech.com)</div>
          <div class='licence'>Licensed under <a href='http://creativecommons.org/licenses/by/3.0/'>Creative Commons: By Attribution 3.0 License</a></div>
        </div>

        <div style='clear:both'></div>
      </div>
    </div>

    <div id='victory'>
      <div class="shadowbox"></div>
      <div class="overlay">
        <h4> You did it!</h4>

        <p> You saved the day! That was worth <span class='final_score'></span> points!</p>

        <button onclick="location.reload()">Done</button>
      </div>
    </div>

    <div id='defeat'>
      <div class="shadowbox"></div>
      <div class="overlay">
        <h4> Oh no! </h4>

        <p> The cities got destroyed, but you did get <span class='final_score'></span> points!</p>

        <button onclick="location.reload()">Done</button>
      </div>
    </div>

    <script>

      function SetName(){
        let value = $('#username').val()
        Cookies.set('username', value)
        console.log('username set to', value)
      }

      function menu(){
        $('#menu-volume').val(GetVolume()*1000)
        $('#menu').css({display: 'block'})
        let select = $('#songSelect')
        for(let ii = 0; ii < Music.length; ii++){
          let file = Music[ii];
          let name = SongNames[ii];
          $('<option value="' + file + '">' + name + '</option>').appendTo(select);
        }

        let scoreboard = $('#scoreboard');
        for(let ii = 0; ii < Music.length; ii++){
          let name = SongNames[ii];
          let file = Music[ii];
          let current = Cookies.getJSON(file)
          if(!current) continue
          let row = $('<tr>').appendTo(scoreboard)
          $('<td>').html(name).appendTo(row)
          $('<td>').html(current.victory != null ? current.victory : 'NA').appendTo(row)
          $('<td>').html(current.defeat != null ? current.defeat : 'NA').appendTo(row)
        }

        function loadLeaderboard(data){
          console.log(data)
          let board = $('#scoreTables');
          for(let ii = 0; ii < Music.length; ii++){
            let file = Music[ii];
            let name = SongNames[ii];
            if(!data.hasOwnProperty(file)) continue;
            $('<h4>').html(name).appendTo(board)
            let table = $('<table>').appendTo(board)
            table.append($("<tr><th>Player</th><th>In Victory</th><th>In Defeat</th></tr>"))
            for(let player of Object.keys(data[file])){
              let row = $('<tr>').appendTo(table)
              $('<td>').html(player).appendTo(row)
              $('<td>').html(data[file][player][0]).appendTo(row)
              $('<td>').html(data[file][player][1]).appendTo(row)
            }
          }
        }

        //
        if(Cookies.get('username')) $('#username').val(Cookies.get('username'))
        $.ajax({
          url: 'http://jam-stats.douglass.ca:5000/board',
          jsonp: 'callback',
          dataType: 'jsonp',
          success: loadLeaderboard,
        })
      }
      $(menu)

      function submitMenu(){
        startLoadingLevel($('#songSelect').val())
      }

      function startLevel(audioData, soundsData){
        let stats = new Stats()
        document.body.appendChild(stats.dom);
        $(stats.dom).css({
          left: '',
          right: 0,
        })

        // Launch an instance of the game with the tag above as its connection to the page
        $('#main').css({display: 'block'})
        let game = new Game($('#main'), audioData, soundsData)
        var lastTimestamp = 0
        var running = true;

        function render(timestamp){
          stats.begin()
          try{
            window.requestAnimationFrame(render)
            let delta = (timestamp - lastTimestamp)/1000
            lastTimestamp = timestamp
            game.update(delta)
            game.draw(delta)
          } catch (error){
            console.error(error)
          }
          stats.end()
        }
        render(0)
      }


      function startLoadingLevel(path){

        $('#menu').css({display: 'none'})

        console.warn("Show loading screen")

        let spritesReady = false
        let audioReady = false
        let audioData = null
        let soundsReady = false
        let soundsData = null

        function maybeStart(){
          if(spritesReady && audioReady && soundsReady){
            console.warn("hide loading screen")
            startLevel(audioData, soundsData)
          }
        }

        GetMusic(path, (data) => {
          audioData = data
          audioReady = true;
          maybeStart();
        }, Number(Cookies.get('difficulty')))

        // Ask three to load the graphics
        LoadAllSprites(() => {
          spritesReady = true;
          maybeStart()
        })

        LoadAllSounds((data) => {
          soundsData = data
          soundsReady = true;
          maybeStart()
        })
      }

    </script>
  </body>
</html>
